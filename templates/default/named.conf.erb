# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.
<% unless @additional_config_files.nil? || @additional_config_files.empty? -%>

<% @additional_config_files.each do |file| -%>
include "<%= "#{@sysconfdir}/#{file}" %>";
<% end -%>
<% end -%>
<% unless @primaries.nil? || @primaries.empty? -%>

<% @primaries.each do |name, ips| -%>
<% if Gem::Version.new(@bind_version) >= Gem::Version.new('9.16.12') -%>
primaries <%= name %> {
<% else -%>
masters <%= name %> {
<% end -%>
<% ips.each do |i| -%>
  <%= i %>;
<% end -%>
};

<% end -%>
<% end -%>
<% unless @servers.nil? || @servers.empty? -%>

<% @servers.each do |server| -%>
server <%= server.name %> {
<% server.options.each do |option| -%>
  <%= option %>;
<% end -%>
};
<% end -%>
<% end -%>
<% unless @keys.nil? || @keys.empty? -%>

<% @keys.each do |key| -%>
key "<%= key.name %>" {
  algorithm <%= key.algorithm %>;
  secret "<%= key.secret %>";
};
<% end %>
<% end %>
<% unless @views.empty? %>

<% @views.each do |view| %>
view "<%= view.name %>" {
  <% @per_view_additional_config_files.each do |file| -%>
  include "<%= "#{@sysconfdir}/#{file}" %>";
  <% end -%>
<% unless view.match_clients.empty? -%>

  match-clients {
<% view.match_clients.each do |client| -%>
    <%= client -%>;
<% end -%>
  };
<% end -%>
<% unless view.match_destinations.empty? -%>

  match-destinations {
<% view.match_destinations.each do |destination| -%>
    <%= destination -%>;
<% end -%>
  };
<% end -%>
<% if view.match_recursive_only %>

  match-recursive-only yes;
<% end %>
<% unless view.options.empty? -%>
  <% view.options.each do |option| -%>
  <%= option %>;
  <% end -%>
<% end %>
<%=
  render(
    "_zones.erb", cookbook: 'bind', variables: {
      primary_zones: @primary_zones.select { |zone| zone.view == view.name },
      secondary_zones: @secondary_zones.select { |zone| zone.view == view.name },
      forward_zones: @forward_zones.select { |zone| zone.view == view.name },
      linked_zones: @linked_zones.select { |zone| zone.view == view.name },
      stub_zones: @stub_zones.select { |zone| zone.view == view.name },

    }
  ).gsub(/^(.+)$/, '  \1')
%>
  zone "." IN {
    type hint;
    file "named.ca";
  };
};
<% end %>
<% else %>
<% @per_view_additional_config_files.each do |file| -%>
include "<%= "#{@sysconfdir}/#{file}" %>";
<% end -%>
<%=
  render "_zones.erb", cookbook: 'bind', variables: {
    primary_zones: @primary_zones,
    secondary_zones: @secondary_zones,
    forward_zones: @forward_zones,
    linked_zones: [],
    stub_zones: @stub_zones,
  }
-%>

zone "." IN {
  type hint;
  file "named.ca";
};
<% end %>
